# 판타지 시뮬레이션 기획서 v1.1 (정합성 반영판)
기준: **v1.0 통합본(2026-02-05)**을 구현 기준으로 유지하되, 코드/빌드/스키마 불일치로 발생하던 감점 요소를 **문서와 코드에서 동시에 정합화**한 버전.

---

## 0. 이 프로그램은 무엇인가
- **세계관 기반 텍스트 루프 시뮬레이션**: 세계 정세(WorldState)가 유지/붕괴되는 법칙을 “플레이 경험”으로 체득시키는 게임.  
- 원칙: **수치(룰)는 코드가 결정**, **텍스트(상황/선택/요약)는 AI가 변주**한다.  
- 운영: 매 턴 선택을 강제하지 않고 **Auto/Choice/Major/Summary**로 리듬을 구성한다.  
- 플랫폼: 1차 **Java CLI**, 확장으로 **Spring Boot + Web UI + 저장/통계**를 지원한다.

> 위 4줄은 v1.0의 목적/원칙/운영/플랫폼 정의를 그대로 따른다.  

---

## 1. 세계관 설정(요약)
### 1-1. 대륙 권역/지형
- **북부**: 산맥 + 대설원  
- **중앙**: 산맥/산림/평야(혼합)  
- **서부**: 사막 + 고원  
- **동부**: 산림(엘프 중심)  
- **남부**: 평야  

### 1-2. 국가 구도
- 북부: 국가 없음(설원 부족 + 드워프 광산길드 + 마물/유적 중심의 무주지)
- 중앙: 강력한 제국
- 서부: 사막 왕국
- 동부: 엘프 왕국(폐쇄, 관문 통제·상인만 제한적 입국)
- 남부: 7개 소왕국 연합 + 1개 강대한 왕국

### 1-3. 인종 분포(거점)
- 인간: 북부/동부 제외 전역  
- 엘프: 동부 산림(폐쇄적, 왕족 존재)  
- 수인: 북부 설원 + 서부 고원(부족 단위)  
- 드워프: 동부/서부 제외 전역(북부는 산맥 거주)

### 1-4. 신앙/마계 구조
- 인간권: 태양신(주신) 중심 교단 + 4대 신(생명/풍요/질서/흐름) 병행 신앙
- 마계: 강자존 위계. 마왕(달의 악마) 아래 고위마족(4) + 상급마족(7대 죄악)
- **4대 신 ↔ 4 고위마족**: 서로 반대 성질(대립)이며 상호 증오 관계

#### 악마 계층(요약)
마왕(달의 악마) → 고위마족(종언/고갈/왜곡/정체) → 상급마족(7대 죄악) → 중급/하급/마물

### 1-5. 세력 관계/운영 원칙(추가 설정)
- **제국 ↔ 사막왕국**: 이웃. 사막왕국은 평야를 노려 *국지도발* 수준(국경 병력 전진배치/철수). 제국은 거슬리지만 전면전은 부담.
- **제국 ↔ 남부 7개 연합**: 제국은 남부 진출을 원하나 직접 정복보다 **친제국파 지원/정치모략**을 선호. 연합은 친제국파 vs 반제국파 당쟁.
- **제국 ↔ 남부 강대 왕국**: 제국이 밀 수는 있지만 부담. 대신 **남부 연합을 완충지대로 보고 무력 충돌 최소화(중립)**.
- **사막왕국 ↔ 남부 연합**: 제국이 친제국파를 밀면 사막왕국이 **반제국파를 지원**. 정복은 가능하지만 제국 역습 리스크로 신중.
- **남부 강대 왕국 ↔ 남부 연합**: 관심은 크지 않으나 국경이 맞닿아 신경 쓰임. 특산품이 비슷해 교류(무역)는 상대적으로 저조.
- **동부 엘프 왕국**: 민간인 입국은 사실상 불가. **허가 받은 인간**과 **심사 통과 상인**만 관문으로 제한적 입국.
- **태양성 교단**: 포교 때문에 왕국들과 척지는 것을 피하며 정치적으로 중립. 목표는 **마왕 제거**. 활동권(중앙/남부/서부) 내에서는 마물·하급악마·악마숭배자를 처리.
- **마계/침투**: 마경에서 새어나온 하급악마/마물이 귀족을 유혹(힘/부) → 귀족+악마숭배자 협력. 마물은 지능이 낮아 *물질 피해*, 하급악마는 *모략* 포함.
- **북부 수인**: 반(反)악마파는 인간과 교류가 활발. 친(親)악마파는 힘을 원하지만 인간 악마숭배자와도 서로 불신(껄끄러움).


---

## 2. 플레이어 설정
### 2-1. 시작 시 선택 항목 (v2.1 기준)
- 종족(race): human / elf / beast / dwarf
- 이름(name): `nameless=false`일 때 필수
- 이름 없는 자(nameless): 선택(이세계인). `nameless=true`면 **환생/회귀 없음(1회 런)**

### 2-2. 시작 상태(고정)
- 신분(origin): commoner(평민) 고정
- 직업(job): none(무직) 고정
- 신앙(faith): none 고정 (이후 이벤트로 변동 가능)

### 2-3. 직업 결정 방식(플레이 중 YES/NO)
- `site=adventurer_guild` → 모험가(adventurer)
- `site=knight_order` → 기사(knight)
- `site=mage_tower` → 마법사(mage)
- `site=cathedral` → 성직자(priest)
- 성직자(priest) 상태에서 `site=knight_order` 재조우 시 → 성기사(paladin) 제안(YES/NO)

### 2-4. 사이클(환생) 규칙
- 기본 모드: Cycle 종료 후 CycleReport 출력 → MetaState 누적 → **rebirth** 가능
- rebirth 시 변화:
  - 이름: 랜덤 생성
  - 출신(origin): commoner / noble / royal / orphan_cult 중 랜덤
  - 직업(job): none으로 리셋(다시 기관 이벤트로 결정)

### 2-5. “이름 없는 자(이세계인)” 특수 규칙
- **rebirth 불가**: 요청 시 거절(에러)
- CycleReport는 동일하게 출력되지만, 다음 사이클은 시작되지 않는다

---

## 3. 수치/룰 체계(핵심만)
### 3-1. 핵심 상태 변수
- WorldState: empire / demon / cult / publicMood (각 0..100)
- PlayerState: hp(0..100 권장), gold(0..∞), job/tier/race/origin, alignmentScore
- MetaState: hardship / insight(제국/마족/교단) / metaPower (각 0..100 권장)

### 3-2. “강함(power)” 척도
- WorldState(0..100)는 세계 정세, power는 개인 강함(위상/전투력)
- 플레이어 기본 성장 범위: **11~100**, 101+는 “초월 엔딩/메타 조건”에서만 허용

### 3-3. 선/중립/악 점수
- Choice/Major 선택은 GOOD/NEUTRAL/EVIL 중 하나로 누적
- 엔딩 방향 및 일부 확률/세력 반응에만 영향(수치 밸런스와 분리)

---

## 4. 턴/사이클 시스템
### 4-1. 코어 루프
일(日) 단위 반복:
1) 상태 갱신(코드)  
2) 이벤트 판정(코드)  
3) 필요 시 선택지 생성(AI)  
4) 효과 적용(코드)  
5) 로그 기록  

### 4-2. 턴 타입
- Auto: 경미한 변동(로그 1~2줄)
- Choice: 중요도 임계치 이상일 때(상황 1 + 선택 3 고정)
- Major: 정치/전쟁/교단/마계 개입 등 큰 사건(AI 호출)
- Summary: 7일/30일 단위 요약(리포트 품질 강화)

### 4-3. 사이클(환생) 규칙
- 기본 모드: Cycle 종료 시 CycleReport 출력 → MetaState 누적 → rebirth(환생)
- 종료 조건 예: 사망 / 기간 만료 / 세계 붕괴 / 특정 엔딩 트리거
- 예외: “이세계인”은 회귀 불가

---

## 5. 이벤트/태그/AI 계약
### 5-1. 태그 스키마(코드가 결정)
region / terrain / nation / race / faction / threat / theme / difficulty
+ faithSide / politicalAxis / entryPolicy
+ deity / archdemon / demonTier / sin / site
+ playerJob / playerRace / playerOrigin  
- AI는 **입력 태그 범위를 벗어난 설정(새 국가/새 신격/새 위계)을 창조하지 않는다.**  
- 태그는 “세계관 붕괴 방지” 안전장치다.

### 5-2. EventCard vs Effect 분리(가장 중요한 원칙)
- EventCard(제목/상황/선택지 문장)는 AI가 생성 가능  
- Effect(수치 변화)는 rules 테이블로 조회하여 코드가 적용  
- 즉, **choice_id + 태그 조합으로 Effect를 결정**한다.

### 5-3. EventCard JSON 스키마(v1.1)
v1.0 스키마에 “이벤트 식별자(id)”를 **옵션 필드로 추가**했다.  
(캐시/중복 방지/디버깅용. 없으면 코드가 자동 기본값을 넣는다.)

```json
{
  "id": "E-20260206-0001",
  "title": "사건 제목",
  "situation": "2-4문장 상황 설명",
  "choices": [
    {"id":"GOOD","text":"선 선택지 문장"},
    {"id":"NEUTRAL","text":"중립 선택지 문장"},
    {"id":"EVIL","text":"악 선택지 문장"}
  ],
  "tags": ["region:north","theme:survival","threat:monster","difficulty:52","site:none","deity:none","archdemon:none","demonTier:none","sin:none"]
}
```

검증 규칙(코드):
- choices는 3개 고정, id는 GOOD/NEUTRAL/EVIL만 허용
- tags는 입력 태그의 부분집합(키/값 모두 동일)만 허용
- 실패 시 1회 재요청 후 템플릿 이벤트로 폴백

---

## 6. 구현 구조(모듈/역할)
- fantasy-sim-core: domain/engine/ai/io + rules(effects.json) + config(config.json)
- fantasy-sim-cli: 터미널 플레이 루프
- fantasy-sim-api: REST API(세션 생성/next/choose/환생)

---

## 7. v1.1에서 “감점 요소” 정합화 반영 내역(완료)
1) **Maven parent artifactId 불일치 해결**  
   - 루트 pom의 artifactId를 `fantasy-sim-parent`로 정합화(서브모듈 parent와 일치)

2) **EventCard 모델/파서 불일치 해결**  
   - `EventCard.id` 필드 추가  
   - 문서에도 id를 옵션 스키마로 반영(위 5-3)

3) **컴파일 오류 해결**  
   - 더미 AI(DummyAiClient) 내부 문자열 리터럴 줄바꿈이 깨지는 부분 수정

4) **테스트 부재 개선(최소 스모크 테스트)**  
   - Clamp / AI JSON 파싱·검증 / EffectResolver 로딩·클램프 스모크 테스트 추가
